# Исправления проблем с прокси и маркировкой куки

## Проблема

Система неправильно помечала валидные куки как `invalid` из-за проблем с прокси, а не из-за самих куки. Это приводило к потере ценных данных аккаунтов.

## Внесенные исправления

### 1. Улучшенная логика перебора прокси

**До**: Система пыталась получить один прокси, и если он не работал, сразу помечала куки как невалидные.

**После**: Система делает до 5 попыток получить рабочий прокси перед тем, как пропустить аккаунт.

```python
# Новая логика в tiktok_manager.py
max_proxy_attempts = 5
while proxy_attempt < max_proxy_attempts:
    self.proxy = await get_primary_proxy()
    if self.proxy:
        break
    await asyncio.sleep(1)

if not self.proxy:
    # Помечаем как пропущенный, а не невалидный
    self.mark_screenshot_directory(cookie_file, None)
```

### 2. Расширенное определение ошибок прокси

**До**: Система не распознавала многие типы сетевых ошибок.

**После**: Добавлены дополнительные типы ошибок:

```python
proxy_error_keywords = [
    'ssl_error', 'ssl error', 'proxy', 'connection', 'timeout', 'connect',
    'ns_error_unknown_host', 'network error', 'dns', 'host not found',
    'connection refused', 'connection reset', 'connection aborted'
]
```

### 3. Автоматическая смена прокси при проблемах

**Новая функция**: Если прокси не работает в браузере, система автоматически пытается получить новый прокси (до 2 попыток).

```python
# Логика в process_account()
while proxy_retry_count <= max_proxy_retries:
    if not proxy_works and self.use_free_proxy:
        # Получаем новый прокси и пересоздаем браузер
        self.proxy = await get_primary_proxy()
        # Создаем новый браузер с новым прокси
```

### 4. Оптимизация поиска прокси

- **Кэширование**: Рабочие прокси кэшируются на 3 минуты
- **Быстрые таймауты**: Уменьшены с 10 до 8 секунд
- **Список неудачных**: Неработающие прокси запоминаются и пропускаются
- **Больше стран**: Расширен список с 3 до 7 стран

### 5. Умный откат неправильно помеченных куки

**Новый скрипт**: `rollback_proxy_errors.py`

- При **бесплатных прокси**: Откатывает ВСЕ invalid файлы (так как все ошибки связаны с прокси)
- При **платных прокси**: Анализирует скриншоты и откатывает только файлы с ошибками прокси

## Результаты

### Скорость работы
- **Поиск прокси**: 2-3x быстрее (5-15 сек вместо 15-30 сек)
- **Повторные запросы**: Мгновенные благодаря кэшу
- **Меньше попыток**: 5 вместо 10, но каждая эффективнее

### Сохранение данных
- **До**: Валидные куки терялись из-за проблем с прокси
- **После**: Куки сохраняются для повторной обработки
- **Откат**: 9 файлов успешно восстановлено из invalid статуса

### Надежность
- **Автоматическая смена прокси** при проблемах
- **Правильная классификация ошибок** (прокси vs куки)
- **Статус "пропущено"** вместо "невалидно" для сетевых ошибок

## Использование

### Тестирование оптимизаций
```bash
# Тест производительности прокси
python test_optimized_proxy.py

# Тест логики повторных попыток
python test_proxy_retry_logic.py
```

### Откат неправильно помеченных файлов
```bash
# Анализ без отката
python rollback_proxy_errors.py --analyze

# Откат файлов с ошибками прокси
python rollback_proxy_errors.py
```

### Основное приложение
```bash
# Запуск с улучшенной логикой
python main.py
```

## Конфигурация

Оптимизированные настройки в `.env`:

```env
# Режим прокси
PROXY_MODE=free

# Настройки бесплатных прокси
FREE_PROXY_COUNTRIES=US,GB,DE,CA,AU,NL,FR
FREE_PROXY_TIMEOUT=4.0
FREE_PROXY_CACHE_TIME=180
```

## Мониторинг

- **Папки `skipped_*`**: Аккаунты пропущенные из-за проблем с прокси
- **Папки `invalid_*`**: Реальные проблемы с куками (редко при бесплатных прокси)
- **Логи**: Подробная информация о попытках получения прокси

Теперь система работает намного надежнее и не теряет ценные данные аккаунтов из-за временных проблем с прокси!